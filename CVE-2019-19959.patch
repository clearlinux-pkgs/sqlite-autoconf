From f83f7e8141ee7cbbf7f2dc8985279a7372b259b6 Mon Sep 17 00:00:00 2001
From: "D. Richard Hipp" <drh@hwaci.com>
Date: Mon, 23 Dec 2019 21:04:33 +0000
Subject: [PATCH] Fix the zipfile() function in the zipfile extension so that
 it is able to deal with goofy filenames that contain embedded zeros.

FossilOrigin-Name: cc0fb00a128fd0773db5ff7891f7aa577a3671d570166d2cbb30df922344adcf
---
 shell.c   | 4 ++--
 sqlite3.c | 4 ++--
 sqlite3.h | 2 +-
 3 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/shell.c b/shell.c
index 404a8d4..48065e9 100644
--- a/shell.c
+++ b/shell.c
@@ -5841,7 +5841,7 @@ static int zipfileUpdate(
         zFree = sqlite3_mprintf("%s/", zPath);
         if( zFree==0 ){ rc = SQLITE_NOMEM; }
         zPath = (const char*)zFree;
-        nPath++;
+        nPath = (int)strlen(zPath);
       }
     }
 
@@ -6242,11 +6242,11 @@ void zipfileStep(sqlite3_context *pCtx, int nVal, sqlite3_value **apVal){
   }else{
     if( zName[nName-1]!='/' ){
       zName = zFree = sqlite3_mprintf("%s/", zName);
-      nName++;
       if( zName==0 ){
         rc = SQLITE_NOMEM;
         goto zipfile_step_out;
       }
+      nName = (int)strlen(zName);
     }else{
       while( nName>1 && zName[nName-2]=='/' ) nName--;
     }
diff --git a/sqlite3.c b/sqlite3.c
index 19a474d..2e37723 100644
--- a/sqlite3.c
+++ b/sqlite3.c
@@ -1167,7 +1167,7 @@ extern "C" {
 */
 #define SQLITE_VERSION        "3.30.1"
 #define SQLITE_VERSION_NUMBER 3030001
-#define SQLITE_SOURCE_ID      "2019-12-19 22:08:19 c4cc4884893abd8e4b1154f2c96c38ad17b17fd7146c91c501d3de6ddff8alt1"
+#define SQLITE_SOURCE_ID      "2019-12-23 21:04:33 77f3eb9ed8d80ce36ac715396266422b86d24e6e6cc7de34f500e4c97b38alt1"
 
 /*
 ** CAPI3REF: Run-Time Library Version Numbers
@@ -225069,7 +225069,7 @@ SQLITE_API int sqlite3_stmt_init(
 /************** End of stmt.c ************************************************/
 #if __LINE__!=225070
 #undef SQLITE_SOURCE_ID
-#define SQLITE_SOURCE_ID      "2019-12-19 22:08:19 c4cc4884893abd8e4b1154f2c96c38ad17b17fd7146c91c501d3de6ddff8alt2"
+#define SQLITE_SOURCE_ID      "2019-12-23 21:04:33 77f3eb9ed8d80ce36ac715396266422b86d24e6e6cc7de34f500e4c97b38alt2"
 #endif
 /* Return the source-id for this library */
 SQLITE_API const char *sqlite3_sourceid(void){ return SQLITE_SOURCE_ID; }
diff --git a/sqlite3.h b/sqlite3.h
index 88f23a4..d2cd68b 100644
--- a/sqlite3.h
+++ b/sqlite3.h
@@ -125,7 +125,7 @@ extern "C" {
 */
 #define SQLITE_VERSION        "3.30.1"
 #define SQLITE_VERSION_NUMBER 3030001
-#define SQLITE_SOURCE_ID      "2019-12-19 22:08:19 c4cc4884893abd8e4b1154f2c96c38ad17b17fd7146c91c501d3de6ddff8alt1"
+#define SQLITE_SOURCE_ID      "2019-12-23 21:04:33 77f3eb9ed8d80ce36ac715396266422b86d24e6e6cc7de34f500e4c97b38alt1"
 
 /*
 ** CAPI3REF: Run-Time Library Version Numbers
-- 
2.24.1

